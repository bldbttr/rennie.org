# Guide to Verifying and Troubleshooting Carousel Dots

**Issue**: Carousel indicator dots disappearing or not functioning properly  
**Frequency**: Recurring problem in multiple development sessions  
**Impact**: Core carousel navigation feature becomes non-functional  
**Date Created**: September 11, 2025

## Quick Verification Checklist

### 1. Visual Check
- [ ] Load site (locally: `./bin/preview-local.sh`, production: https://rennie.org)
- [ ] Wait for first image to load
- [ ] Look for 3 small dots at bottom center of image panel
- [ ] Verify dots are visible against current image background
- [ ] Check if dots respond to hover (slight scale effect)
- [ ] Test clicking dots to navigate between image variations

### 2. Browser Developer Tools Check
```javascript
// Open browser console and run:
document.querySelectorAll('.carousel-indicators').length  // Should be 1
document.querySelectorAll('.carousel-dot').length         // Should be 3
```

## Common Root Causes & Solutions

### Issue #1: CSS Cascade Conflicts with Fade Transitions

**Symptoms**: Dots disappear during quote-to-quote transitions, may reappear afterward

**Root Cause**: 
- Carousel indicators positioned within `image-panel` element
- Quote transitions apply `fade-to-black` class to `image-panel`
- `.fade-to-black` uses `opacity: 0 !important`, hiding all child elements

**Investigation Commands**:
```javascript
// Check if fade classes are applied during transitions
document.querySelector('.image-panel').classList.contains('fade-to-black')
document.querySelector('.image-panel').classList.contains('fade-from-black')

// Check current opacity of indicators
getComputedStyle(document.querySelector('.carousel-indicators')).opacity
```

**Solution**: Add CSS override rules to preserve indicator visibility
```css
/* Ensure carousel indicators remain visible during fade transitions */
.fade-to-black .carousel-indicators,
.fade-from-black .carousel-indicators {
    opacity: 1 !important;
    pointer-events: auto !important;
}

.fade-to-black .carousel-indicators.hidden,
.fade-from-black .carousel-indicators.hidden {
    opacity: 0 !important;
}
```

**Files to Check/Update**:
- **Source**: `/scripts/templates/style.css` 
- **Generated**: `/output/style.css`

### Issue #2: Template-Generated File Edits Lost During Deployment

**Symptoms**: Dots work locally but disappear after GitHub Actions deployment

**Root Cause**: 
- Edits made directly to `/output/style.css` or `/output/script.js`
- Build system regenerates these files from templates during deployment
- Direct edits are overwritten and lost

**Investigation Commands**:
```bash
# Check if files are template-generated
grep -n "Generated by build_site.py" /output/style.css
grep -n "Generated by build_site.py" /output/script.js

# Check source templates for carousel code
grep -n "carousel-indicators" scripts/templates/style.css
grep -n "ImageCarousel" scripts/templates/app.js
```

**Solution**: Always edit source templates, not output files
- **❌ Never edit**: `/output/style.css`, `/output/script.js`, `/output/index.html`  
- **✅ Always edit**: `/scripts/templates/style.css`, `/scripts/templates/app.js`, `/scripts/templates/index.html`

**Recovery Process**:
1. Locate working carousel code in git history: `git log --oneline -p | grep -A 5 -B 5 "carousel-indicators"`
2. Copy working CSS/JS to appropriate source template files
3. Run build process: `python scripts/build_site.py`
4. Test locally: `./bin/preview-local.sh`
5. Deploy: `./bin/commit-and-deploy.sh`

### Issue #3: JavaScript Carousel Class Not Initialized

**Symptoms**: Dots visible but not functional, no auto-advance between images

**Root Cause**: 
- `ImageCarousel` class not properly instantiated
- Event listeners not attached
- Timer functionality not started

**Investigation Commands**:
```javascript
// Check if carousel instance exists
window.currentCarousel  // Should be an ImageCarousel instance

// Check if dots have click listeners
document.querySelectorAll('.carousel-dot').forEach(dot => {
    console.log('Dot listeners:', getEventListeners(dot))
})

// Check if auto-advance timer is running
window.currentCarousel && window.currentCarousel.timer  // Should not be null
```

**Solution**: Verify carousel initialization in main display function
```javascript
// Should be in displayCurrentContent() function
if (content.images && content.images.length > 1) {
    this.currentCarousel = new ImageCarousel(content.images, {
        imageDuration: this.config.display.image_duration,
        transitionDuration: this.config.display.transition_duration
    });
    this.currentCarousel.start();
}
```

### Issue #4: HTML Structure Missing Carousel Container

**Symptoms**: No dots visible at all, console shows 0 carousel elements

**Root Cause**: 
- Missing carousel indicators container in HTML template
- Container not being created dynamically

**Investigation Commands**:
```javascript
// Check HTML structure
document.querySelector('.image-panel .carousel-indicators')  // Should exist
document.querySelector('.image-panel').innerHTML.includes('carousel-indicators')
```

**Solution**: Add carousel container to HTML template
```html
<div class="image-panel">
    <div class="image-container">
        <!-- Image goes here -->
    </div>
    <div class="carousel-indicators hidden">
        <!-- Dots created dynamically -->
    </div>
</div>
```

**Files to Check/Update**:
- **Source**: `/scripts/templates/index.html`
- **Generated**: `/output/index.html`

## Systematic Debugging Process

### Step 1: HTML Structure Verification
```bash
# Check if carousel container exists in templates
grep -n "carousel-indicators" scripts/templates/index.html

# Check if container exists in output
grep -n "carousel-indicators" output/index.html
```

### Step 2: CSS Rules Verification
```bash
# Check carousel CSS in source template
grep -A 10 -B 5 "carousel-indicators" scripts/templates/style.css

# Check CSS override rules for fade conflicts
grep -A 5 "fade-to-black.*carousel-indicators" scripts/templates/style.css
```

### Step 3: JavaScript Functionality Verification
```bash
# Check carousel class exists in source template
grep -A 10 -B 5 "class ImageCarousel" scripts/templates/app.js

# Check carousel initialization logic
grep -A 10 -B 5 "new ImageCarousel" scripts/templates/app.js
```

### Step 4: Build Process Verification
```bash
# Run build and check for errors
python scripts/build_site.py

# Verify carousel elements were generated
grep -n "carousel-indicators" output/index.html
grep -n "ImageCarousel" output/script.js
```

### Step 5: Local Testing
```bash
# Start local server
./bin/preview-local.sh

# In browser console:
# - Check carousel initialization
# - Test dot clicking
# - Verify auto-advance timers
```

## Production vs Local Differences

### Common Discrepancies
- **Template Integration**: Local testing may use development files that bypass template system
- **Build Process**: Production uses GitHub Actions build, local uses direct Python script
- **Caching**: Browser/CDN caching may show old versions in production

### Verification Process
```bash
# Deploy to production and test
./bin/commit-and-deploy.sh

# Check GitHub Actions logs for build errors
gh run list --limit 5
gh run view --log [run-id]

# Compare local vs production file content
curl -s https://rennie.org/style.css | grep "carousel-indicators" -A 5 -B 5
```

## Emergency Recovery Checklist

When carousel dots are completely missing:

### 1. Quick Fix (Temporary)
```bash
# Create development carousel file for immediate testing
cp scripts/templates/app.js output/script_carousel.js
# Edit output/index.html to include script_carousel.js temporarily
```

### 2. Proper Fix (Permanent)
```bash
# 1. Verify source templates have carousel code
grep -n "carousel-indicators" scripts/templates/style.css
grep -n "ImageCarousel" scripts/templates/app.js

# 2. If missing, recover from git history
git log --oneline | head -10
git show [commit-with-working-carousel]:scripts/templates/style.css > temp_style.css
# Copy carousel CSS rules to source template

# 3. Rebuild and test
python scripts/build_site.py
./bin/preview-local.sh

# 4. Deploy
./bin/commit-and-deploy.sh
```

## Prevention Strategies

### 1. Template Awareness
- Always check if file exists in `/scripts/templates/` before editing
- Look for "Generated by build_site.py" comments in files
- Use development files for testing, templates for permanent changes

### 2. Testing Protocol
- Test locally before deployment: `./bin/preview-local.sh`
- Verify carousel functionality in multiple browsers
- Check production deployment immediately after GitHub Actions complete

### 3. Documentation
- Keep this guide updated with new failure modes
- Document any new carousel features with troubleshooting steps
- Reference this guide in commit messages when fixing carousel issues

## File Reference Quick Guide

### Source Files (Edit These)
- `/scripts/templates/style.css` - Carousel CSS rules
- `/scripts/templates/app.js` - ImageCarousel class and initialization
- `/scripts/templates/index.html` - HTML structure with carousel container

### Generated Files (Check These, Don't Edit)
- `/output/style.css` - Generated carousel styles
- `/output/script.js` - Generated carousel functionality  
- `/output/index.html` - Generated HTML with carousel container

### Development Files (Testing Only)
- `/output/script_carousel.js` - Temporary development file
- Create other development files as needed for isolation testing

## Known Issues History

### September 10, 2025 - Initial Implementation
- Template-generated code confusion
- Direct output file editing caused feature loss during deployment

### September 11, 2025 - CSS Cascade Conflict
- Fade transition conflicts with `opacity: 0 !important`
- Required CSS override rules for visibility preservation
- User reported: "Hey what happened? We lost the carousel dots?"

### September 11, 2025 - Recurring Template Issues
- Multiple instances of same template management problem
- Added comprehensive documentation and prevention strategies
- User feedback: "We seem to keep losing this feature"

## Success Criteria

A properly functioning carousel should have:
- ✅ 3 visible dots at bottom center of image panel
- ✅ Active dot highlighting (white vs translucent) 
- ✅ Clickable dot navigation between image variations
- ✅ Auto-advance every 10 seconds (configurable)
- ✅ Smooth cross-fade transitions between images
- ✅ Dots remain visible during quote-to-quote transitions
- ✅ Touch gesture support for mobile navigation
- ✅ Ken Burns animation effects on images
- ✅ Proper pause/resume on user interaction

**Final Note**: This recurring issue highlights the importance of understanding template-generated vs source files in projects with build systems. The problem is architectural, not just code-based, requiring process awareness to prevent.