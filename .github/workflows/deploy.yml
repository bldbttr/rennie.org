name: Generate and Deploy Site

on:
  push:
    branches:
      - main
    paths:
      - 'content/**'
  workflow_dispatch:  # Allow manual triggering for testing

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    environment: DREAMHOST_SSH_KEY
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper git operations
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('scripts/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
      
      - name: Parse content
        run: |
          echo "ðŸ“ Parsing content files..."
          python scripts/content_parser.py
          if [ $? -eq 0 ]; then
            echo "âœ… Content parsing completed successfully"
          else
            echo "âŒ Content parsing failed"
            exit 1
          fi
      
      - name: Test script imports
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ðŸ” Testing script imports and basic functionality..."
          echo "Python version: $(python --version)"
          echo "Working directory: $(pwd)"
          echo "Environment variables:"
          echo "  GEMINI_API_KEY set: $([ -n "$GEMINI_API_KEY" ] && echo "yes" || echo "no")"
          echo "Installed packages:"
          pip list | grep -E "(google|pillow|numpy|pyyaml)"
          echo "Testing Python imports..."
          python -c "
          import sys
          print('Python path:', sys.path)
          try:
              import google.genai
              print('âœ… google.genai imported successfully')
          except Exception as e:
              print('âŒ google.genai import failed:', e)
          try:
              import PIL
              print('âœ… PIL imported successfully')
          except Exception as e:
              print('âŒ PIL import failed:', e)
          try:
              sys.path.append('scripts')
              from content_parser import ContentParser
              print('âœ… content_parser imported successfully')
          except Exception as e:
              print('âŒ content_parser import failed:', e)
          "
          echo "Testing basic script execution..."
          python -c "
          import os
          os.environ['GEMINI_API_KEY'] = os.environ.get('GEMINI_API_KEY', 'test')
          try:
              import sys
              sys.path.append('scripts')
              from generate_images import ImageGenerator
              print('âœ… ImageGenerator class imported successfully')
          except Exception as e:
              print('âŒ ImageGenerator import failed:', e)
              import traceback
              traceback.print_exc()
          "
          
      - name: Generate new images
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ðŸŽ¨ Generating images for new content..."
          python scripts/generate_images.py --new-only --variations 1
          exit_code=$?
          echo "Image generation exit code: $exit_code"
          if [ $exit_code -eq 0 ]; then
            echo "âœ… Image generation completed successfully"
            # Check if any new images were created
            if [ -n "$(git status --porcelain generated/images/)" ]; then
              echo "ðŸ“¸ New images were generated"
              echo "NEW_IMAGES_GENERATED=true" >> $GITHUB_ENV
            else
              echo "â„¹ï¸ No new images needed"
              echo "NEW_IMAGES_GENERATED=false" >> $GITHUB_ENV
            fi
          else
            echo "âŒ Image generation failed with exit code: $exit_code"
            exit 1
          fi
      
      - name: Build static site
        run: |
          echo "ðŸ”¨ Building static site..."
          python scripts/build_site.py
          if [ $? -eq 0 ]; then
            echo "âœ… Site build completed successfully"
            # List output directory contents for verification
            echo "ðŸ“ Output directory contents:"
            ls -la output/
          else
            echo "âŒ Site build failed"
            exit 1
          fi
      
      - name: Setup SSH key for deployment
        env:
          SSH_PRIVATE_KEY: ${{ vars.DREAMHOST_SSH_KEY }}
        run: |
          echo "ðŸ” Setting up SSH key..."
          echo "SSH key environment variable set: $([ -n "$SSH_PRIVATE_KEY" ] && echo "yes" || echo "no")"
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo "SSH key file size: $(wc -c < ~/.ssh/deploy_key) bytes"
          echo "SSH key first line: $(head -1 ~/.ssh/deploy_key)"
          echo "SSH key last line: $(tail -1 ~/.ssh/deploy_key)"
          # Validate SSH key format
          ssh-keygen -l -f ~/.ssh/deploy_key || echo "âš ï¸ SSH key validation failed"
          # Add DreamHost to known hosts to prevent interactive prompt
          ssh-keyscan -H iad1-shared-e1-05.dreamhost.com >> ~/.ssh/known_hosts 2>/dev/null
          echo "âœ… SSH key setup completed"
      
      - name: Deploy to DreamHost
        run: |
          echo "ðŸš€ Deploying to DreamHost..."
          # Use rsync with proper flags for static site deployment
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            output/ \
            rennie@iad1-shared-e1-05.dreamhost.com:/home/rennie/rennie.org/
          
          if [ $? -eq 0 ]; then
            echo "âœ… Deployment completed successfully"
            echo "ðŸŒ Site is live at https://rennie.org"
          else
            echo "âŒ Deployment failed"
            exit 1
          fi
      
      - name: Commit generated images back to repository
        if: env.NEW_IMAGES_GENERATED == 'true'
        run: |
          echo "ðŸ’¾ Committing new images to repository..."
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          # Add only the generated images directory
          git add generated/images/
          git add generated/metadata/
          git add generated/*.json
          
          # Commit with descriptive message
          git commit -m "ðŸŽ¨ Generated images for new content

          Automated image generation via GitHub Actions.
          Generated by Nano Banana (Gemini 2.5 Flash Image Preview)
          
          [skip ci]" || echo "No changes to commit"
          
          # Push back to main branch
          git push origin main
          
          if [ $? -eq 0 ]; then
            echo "âœ… Images committed successfully"
          else
            echo "âš ï¸ Could not push images (may need permissions configuration)"
          fi
      
      - name: Cleanup sensitive data
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          rm -f ~/.ssh/deploy_key
          echo "âœ… Cleanup completed"
      
      - name: Report summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Deployment successful!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ Site is live at: [rennie.org](https://rennie.org)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Deployment failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Steps completed:" >> $GITHUB_STEP_SUMMARY
          echo "- Content parsing" >> $GITHUB_STEP_SUMMARY
          echo "- Image generation (new content only)" >> $GITHUB_STEP_SUMMARY
          echo "- Static site build" >> $GITHUB_STEP_SUMMARY
          echo "- Deployment to DreamHost" >> $GITHUB_STEP_SUMMARY
          
          if [ "$NEW_IMAGES_GENERATED" == "true" ]; then
            echo "- New images committed to repository" >> $GITHUB_STEP_SUMMARY
          fi